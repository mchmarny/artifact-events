steps:

  - id: config
    name: bash
    script: |
      #!/usr/bin/env bash
      echo ${_DIGEST} | cut -d@ -f2 > digest.txt
      echo ${_DIGEST} > image.txt

  - id: snyk
    name: docker.io/snyk/snyk:docker
    allowExitCodes: [0, 1]
    args: ['snyk', 'container', 'test', '--app-vulns', '--json-file-output=snyk.json', '${_DIGEST}']
    env:
    - 'SNYK_TOKEN=${_SNYK_TOKEN}'

  - id: grype
    name: docker.io/anchore/grype
    args: ['-s', 'AllLayers', '-o', 'json', '--file', 'grype.json', '${_DIGEST}']

  - id: trivy
    name: docker.io/aquasec/trivy
    args: ['image', '--format', 'json', '--scanners', 'vuln', '--output', 'trivy.json', '${_DIGEST}']

  - id: save
    name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: /bin/bash
    waitFor:
    - config
    - snyk
    - grype
    - trivy
    args:
    - -c
    - |-
      IMG_DIGEST=$(cat digest.txt)
      BUCKET_URI="gs://${_BUCKET}/${IMG_DIGEST}/"
      gcloud storage cp ./*.txt $BUCKET_URI
      gcloud storage cp ./*.json $BUCKET_URI
