steps:

  # If the image is not passed by digest, we need to resolve it to a digest
  - id: cofig
    name: gcr.io/cloud-builders/docker
    entrypoint: /bin/bash
    args:
    - -c
    - |-
      uri=${_DIGEST}
      if [[ "${uri}" != *"@"* ]];then
         uri=$(docker inspect --format='{{index .RepoDigests 0}}' ${_DIGEST}) 
      fi
      echo ${uri} > digest.txt
      echo $(echo ${uri} | cut -d: -f2) > sha.txt

  - id: scan-snyk
    name: docker.io/snyk/snyk:docker
    allowExitCodes: [0, 1]
    args: ['snyk', 'container', 'test', '--app-vulns', '--json-file-output=snyk.json', $(cat digest.txt)]
    env:
    - 'SNYK_TOKEN=${_SNYK_TOKEN}'

  - id: save-snyk
    name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: /bin/bash
    waitFor:
    - scan-snyk
    args:
    - -c
    - |-
      uri=gs://${_BUCKET}/$(cat sha.txt)-snyk.json
      gcloud storage cp snyk.json $uri
      gcloud pubsub topics publish image-scans --message=${_DIGEST} \
        --attribute="file=$uri,format=snyk"

  - id: scan-grype
    name: docker.io/anchore/grype
    args: ['-s', 'AllLayers', '-o', 'json', '--file', 'grype.json', $(cat digest.txt)]

  - id: save-grype
    name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: /bin/bash
    waitFor:
    - scan-grype
    args:
    - -c
    - |-
      uri=gs://${_BUCKET}/$(cat sha.txt)-grype.json
      gcloud storage cp grype.json $uri
      gcloud pubsub topics publish image-scans --message=${_DIGEST} \
        --attribute="file=$uri,format=grype"

  - id: scan-trivy
    name: docker.io/aquasec/trivy
    args: ['image', '--format', 'json', '--scanners', 'vuln', '--output', 'trivy.json', $(cat digest.txt)]

  - id: save-trivy
    name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: /bin/bash
    waitFor:
    - scan-trivy
    args:
    - -c
    - |-
      uri=gs://${_BUCKET}/$(cat sha.txt)-trivy.json
      gcloud storage cp trivy.json $uri
      gcloud pubsub topics publish image-scans --message=$(cat digest.txt) \
        --attribute="file=$uri,format=trivy"
