steps:

  - id: config
    name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: /bin/bash
    args:
    - -c
    - |-
      gcloud auth configure-docker

  - id: parse
    name: gcr.io/cloud-builders/docker
    waitFor:
    - config
    entrypoint: /bin/bash
    args:
    - -c
    - |-
      echo "image: ${_IMAGE}"
      docker pull ${_IMAGE}
      digest=$(docker inspect --format='{{index .RepoDigests 0}}' ${_IMAGE})
      if test -z "$digest"; then
        echo "ERROR: can't get digest for $img"
        exit 1
      fi
      echo "parsed digest: $digest"
      # docker returns only the image name and digest
      # need to add the registry to the image name together to ensure a valid URI
      uri=$(echo ${_IMAGE} | cut -d: -f1)
      digest=$(echo $digest | cut -d@ -f2)
      uri="${uri}@${digest}"
      echo "parsed image uri: $uri"
      echo $uri > uri.txt

  - id: publish
    name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: /bin/bash
    args:
    - -c
    - |-
      gcloud pubsub topics publish image-queue --message=$(cat uri.txt)
